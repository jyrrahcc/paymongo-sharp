@page "/sources"
@using Paymongo.Sharp.Interfaces
@using Paymongo.Sharp.Core.Enums
@using Paymongo.Sharp.Core.Entities
@using Paymongo.Sharp.Sources.Entities

@inject IPaymongoClient PaymongoClient
@inject IJSRuntime JsRuntime

<h3>Sources</h3>

<button class="btn btn-primary" disabled="@_isProcessing" @onclick="OnPayGrab">Pay with GrabPay</button>
<button class="btn btn-primary" disabled="@_isProcessing" @onclick="OnPayGcash">Pay with GCash</button>

@if (_isProcessing)
{
    <div class="d-flex flex-row alert alert-secondary mt-3" role="alert">
        <div class="spinner-border text-dark" role="status">
        </div>
        <p class="my-auto mx-2">Waiting for transaction to complete..</p>
    </div>
}

@code {
    
    private bool _isProcessing;

    async Task OnPayGrab()
    {
        _isProcessing = true;
        var source = new Source {
            Amount = 100000,
            Billing = new Billing {
                Name = "TestName",
                Email = "test@paymongo.com",
                Phone = "9734534443",
                Address = new Address {
                    Line1 = "TestAddress1",
                    Line2 = "TestAddress2",
                    PostalCode = "4506",
                    State = "TestState",
                    City = "TestCity",
                    Country = "PH"
                }
            },
            Redirect = new Redirect {
                Success = "https://localhost:7213/success",
                Failed = "https://localhost:7213/failed"
            },
            Type = SourceType.GrabPay,
            Currency = Currency.Php
        };
        
        Source sourceResult = await PaymongoClient.Sources.CreateSourceAsync(source);
        await JsRuntime.InvokeVoidAsync("open", sourceResult.Redirect.CheckoutUrl, "_blank");
        _isProcessing = false;

    }
    
    async Task OnPayGcash()
    {
        _isProcessing = true;
        var source = new Source {
            Amount = 100000,
            Billing = new Billing {
                Name = "TestName",
                Email = "test@paymongo.com",
                Phone = "9734534443",
                Address = new Address {
                    Line1 = "TestAddress1",
                    Line2 = "TestAddress2",
                    PostalCode = "4506",
                    State = "TestState",
                    City = "TestCity",
                    Country = "PH"
                }
            },
            Redirect = new Redirect {
                Success = "https://localhost:7213/success",
                Failed = "https://localhost:7213/failed"
            },
            Type = SourceType.GCash,
            Currency = Currency.Php
        };
        
        Source sourceResult = await PaymongoClient.Sources.CreateSourceAsync(source);
        await JsRuntime.InvokeVoidAsync("open", sourceResult.Redirect.CheckoutUrl, "_blank");
        _isProcessing = false;
    }
}